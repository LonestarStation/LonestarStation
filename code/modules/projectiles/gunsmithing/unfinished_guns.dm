//here we have the unfinished guns for lonestar gunsmithing, this file is finished, its just the guns that arent.

//Pistoles VVV (pistols)

/obj/item/unfinished_gun/colt/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/colt/empty)

/obj/item/unfinished_gun/sec/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/sec/empty)

/obj/item/unfinished_gun/deagle/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/deagle/empty)

/obj/item/unfinished_gun/compact/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/pistol/empty)

/obj/item/unfinished_gun/derringer/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/derringer/empty)

/obj/item/unfinished_gun/luger/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/luger/empty)

/obj/item/unfinished_gun/p92x/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/p92x/empty)

/obj/item/unfinished_gun/compact_45/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/compact_45/empty)

/obj/item/unfinished_gun/mini_uzi/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/automatic/mini_uzi/empty)

/obj/item/unfinished_gun/revolver_colt/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/revolver)

/obj/item/unfinished_gun/revolver_gold/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/revolver/gold/empty)

/obj/item/unfinished_gun/mateba/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/revolver/mateba/empty)

/obj/item/unfinished_gun/deckard/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/revolver/deckard/empty)

/obj/item/unfinished_gun/judge/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/revolver/judge/empty)

/obj/item/unfinished_gun/lemat/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/revolver/lemat/empty)

/obj/item/unfinished_gun/webley/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/revolver/webley/empty)

/obj/item/unfinished_gun/webley_auto/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/revolver/webley/auto/empty)

/obj/item/unfinished_gun/webley_large/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/revolver/webley/large/empty)

/obj/item/unfinished_gun/webley_magnetic/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/revolver/webley/magnetic/empty)

/obj/item/unfinished_gun/contender/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/contender/empty)

/obj/item/unfinished_gun/dartgun/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/dartgun)

/obj/item/unfinished_gun/proto_dartgun/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/dartgun/research)

//Scatterguns VVV (shotguns)

/obj/item/unfinished_gun/pumpshotgun/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/shotgun/pump/empty)

/obj/item/unfinished_gun/combatshotgun/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/shotgun/pump/combat/empty)

/obj/item/unfinished_gun/doublebarrelshotgun/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/shotgun/doublebarrel/empty)

/obj/item/unfinished_gun/sawnshotgun/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/shotgun/doublebarrel/sawn/empty)

/obj/item/unfinished_gun/semishotgun/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/shotgun/semi/empty)

/obj/item/unfinished_gun/autoshotgun/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/automatic/as24/empty)

//Longarms VVV (rifles)

/obj/item/unfinished_gun/boltaction/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/shotgun/pump/rifle)

/obj/item/unfinished_gun/practice_boltaction/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/shotgun/pump/rifle/practice/empty)

/obj/item/unfinished_gun/ceremonial/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/shotgun/pump/rifle/ceremonial/empty)

/obj/item/unfinished_gun/leveraction/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/shotgun/pump/rifle/lever/empty)

/obj/item/unfinished_gun/brushgun/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/shotgun/pump/rifle/lever/brushgun/empty)

/obj/item/unfinished_gun/garand/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/garand/empty)

/obj/item/unfinished_gun/revolvingrifle/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/revolvingrifle/empty)

/obj/item/unfinished_gun/SVD/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/SVD/empty)

//Ammo Eaters VVV (automatic weapons)

/obj/item/unfinished_gun/advanced_smg/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/automatic/advanced_smg)

/obj/item/unfinished_gun/c20r/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/automatic/c20r/empty)

/obj/item/unfinished_gun/sts35/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/automatic/sts35/empty)

/obj/item/unfinished_gun/wt550/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/automatic/wt550/empty)

/obj/item/unfinished_gun/z8/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/automatic/z8/empty)

/obj/item/unfinished_gun/l6_saw/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/automatic/l6_saw/empty)

/obj/item/unfinished_gun/p90/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/automatic/p90/empty)

/obj/item/unfinished_gun/pearlshield/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/automatic/pearlshield/empty)

/obj/item/unfinished_gun/tommygun/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/automatic/tommygun/empty)

/obj/item/unfinished_gun/combatsmg/Initialize(var/ml)
	. = ..(ml, /obj/item/gun/projectile/automatic/combatsmg/empty)


//unfinished gun code, stolen from broken guns... which looking back on that, maybe isn't the best sign. too late t'worry now partner!

/obj/item/unfinished_gun
	desc = "An incomplete firearm."

	var/obj/item/gun/my_guntype = null

	// Materials needed for completion. Associative list, path - number of items
	var/list/material_needs

	var/do_rotation = TRUE

/obj/item/unfinished_gun/Initialize(var/ml, var/path)
	. = ..(ml)
	if(path)
		if(!setup_gun(path))
			qdel(src)
			return
		setup_repair_needs()
	addtimer(CALLBACK(src, .proc/validate_gun_type), 30 SECONDS)

/obj/item/unfinished_gun/proc/validate_gun_type()
	if(!my_guntype && !QDELETED(src))
		qdel(src)

/obj/item/unfinished_gun/examine(mob/user, distance, infix, suffix)
	. = ..()
	spawn()
		if(get_dist(get_turf(user),get_turf(src)) <= 1)
			to_chat(user, "<span class='notice'>You begin inspecting \the [src].</span>")

			if(do_after(user, 5 SECONDS))
				to_chat(user, "<span class='notice'>\The [src] can possibly be finished with:</span>")
				for(var/resource in material_needs)
					var/obj/item/res = resource
					if(material_needs[resource] > 0)
						var/res_name = ""
						if(ispath(res,/obj/item/stack/material))
							var/obj/item/stack/material/mat_stack = res
							var/datum/material/mat = get_material_by_name("[initial(mat_stack.default_type)]")
							if(material_needs[resource]>1)
								res_name = "[mat.use_name] [mat.sheet_plural_name]"
							else
								res_name = "[mat.use_name] [mat.sheet_singular_name]"
						else
							res_name = initial(res.name)
						to_chat(user, "<span class='notice'>- x [material_needs[resource]] [res_name]</span>")

/obj/item/unfinished_gun/proc/setup_gun(var/obj/item/gun/path)
	if(ispath(path))
		name = "[pick("unfinished", "incomplete")] [initial(path.name)]"
		icon = initial(path.icon)
		icon_state = initial(path.icon_state)

		my_guntype = path

		w_class = initial(path.w_class)

		if(do_rotation)
			adjust_rotation(rand() * pick(-1,1) * rand(0, 45))

		return TRUE

	return FALSE

/obj/item/unfinished_gun/proc/setup_repair_needs()
	if(!LAZYLEN(material_needs))
		material_needs = list()

	if(ispath(my_guntype, /obj/item/gun/projectile) && prob(40))
		var/chosen_mat = pick(/obj/item/stack/material/steel, /obj/item/stock_parts/spring)
		material_needs[chosen_mat] = rand(1,2)

	if(prob(30))
		var/component_needed = pick(/obj/item/stock_parts/gear,/obj/item/stock_parts/spring,/obj/item/stock_parts/manipulator)
		material_needs[component_needed] = rand(1,2)

	if(ispath(my_guntype, /obj/item/gun/energy) && prob(25))
		var/component_needed = pick(/obj/item/stack/cable_coil, /obj/item/stock_parts/scanning_module,/obj/item/stock_parts/capacitor)
		material_needs[component_needed] = rand(1,2)

	if(ispath(my_guntype, /obj/item/gun/launcher) && prob(50))
		var/component_needed = pick(/obj/item/stack/rods, /obj/item/stack/material/steel)
		material_needs[component_needed] = rand(1,2)

	if(ispath(my_guntype, /obj/item/gun/magnetic) && prob(70))
		var/component_needed = pick(/obj/item/smes_coil, /obj/item/assembly/prox_sensor, /obj/item/module/power_control)
		material_needs[component_needed] = 1

	material_needs[/obj/item/stack/material/steel] = rand(1,2)

/obj/item/unfinished_gun/attackby(obj/item/W as obj, mob/user as mob)
	if(can_repair_with(W, user))
		if(do_after(user, (rand() * 10 SECONDS) + 5 SECONDS))
			repair_with(W, user)
		return

	..()

/obj/item/unfinished_gun/proc/can_repair_with(obj/item/I, mob/user)
	for(var/path in material_needs)
		if(ispath(path) && istype(I, path))
			if(material_needs[path] > 0)
				if(istype(I, /obj/item/stack))
					var/obj/item/stack/S = I
					if(S.can_use(material_needs[path]))
						return TRUE
					else
						to_chat(user, "<span class='notice'>You do not have enough [path] to complete this weapon.</span>")
				else
					return TRUE

	return FALSE

/obj/item/unfinished_gun/proc/repair_with(obj/item/I, mob/user)
	for(var/path in material_needs)
		if(ispath(path) && istype(I, path))
			if(material_needs[path] > 0)
				if(istype(I, /obj/item/stack))
					var/obj/item/stack/S = I
					if(S.can_use(material_needs[path]))
						S.use(material_needs[path])
						material_needs[path] = 0
						to_chat(user, "<span class='notice'>You add some material to \the [src] with \the [S].</span>")
				else
					material_needs[path] = max(0, material_needs[path] - 1)
					user.drop_from_inventory(I)
					to_chat(user, "<span class='notice'>You add some material to \the [src] with \the [I].</span>")
					qdel(I)

	check_complete_repair(user)

	return

/obj/item/unfinished_gun/proc/check_complete_repair(mob/user)
	var/fully_repaired = TRUE
	for(var/resource in material_needs)
		if(material_needs[resource] > 0)
			fully_repaired = FALSE
			break

	if(fully_repaired)
		my_guntype = new my_guntype(get_turf(src))
		my_guntype.name = "[pick("new", "shiny", "fresh")] [initial(my_guntype.name)]"
		to_chat(user, "<span class='notice'>You finish \the [my_guntype].</span>")
		qdel(src)
